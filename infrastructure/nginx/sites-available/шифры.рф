# Основной HTTPS сервер
server {
    server_name xn--h1aqlos.xn--p1ai;
    root /var/www/shifry/static_frontend;
    
    # Основные настройки
    index index.html;
    charset utf-8;

    # Базовые заголовки безопасности
    include /etc/nginx/conf.d/security.conf;

    # Расширенная защита от ботов 
    if ($http_user_agent ~* (Wget|Curl|python|nikto|scanner|^$|bash|nmap|paros|havij|chakram|sqlmap|acunetix|ZAP|w3af|hydra|brutus|nuclei)) { 
        return 444; 
    }

    # Блокируем опасные методы 
    if ($request_method !~ ^(GET|POST|HEAD)$) { 
        return 444; 
    }

    # Основной location блок
    location / {
        # no-cache только для HTML
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate" always;
        # Заголовки GeoIP2
        add_header X-Real-IP $remote_addr always;
        add_header X-Country-Name $geoip2_data_country_name always;
        add_header X-City $geoip2_data_city_name always;
        add_header Access-Control-Expose-Headers 'X-Real-IP, X-Country-Name, X-City' always;
        # Заголовки безопасности
        include /etc/nginx/conf.d/security.conf;
        try_files $uri $uri/ =404;
    }

    # Бэкенд
    include /etc/nginx/conf.d/api_locations/shifry.conf;

    # Блок изображений
    location ~* \.(jpg|jpeg|png|gif|ico|svg|webp|woff|woff2|ttf|eot)$ {
        expires 7d;
        add_header Cache-Control "public";
        access_log off;
        # Заголовки безопасности
        include /etc/nginx/conf.d/security.conf;
        # Оптимизация передачи
        aio threads;
    }

    # Блок видео
    location ~* \.(mp4|webm|ogg|m3u8|ts)$ {
        expires 7d;
        add_header Cache-Control "public, max-age=604800";
        add_header Accept-Ranges bytes;
        access_log off;
        # Заголовки безопасности
        include /etc/nginx/conf.d/security.conf;
        aio threads;
    }

    # Блок CSS/JS с ETag
    location ~* \.(css|js)$ {
        expires 7d;
        add_header Cache-Control "public, must-revalidate";
        etag on;
        access_log off;
        # Заголовки безопасности
        include /etc/nginx/conf.d/security.conf;
    }
    
    # Защита от доступа к скрытым файлам
    location ~ /\. {
        deny all;
    }

    # Блокировка доступа к конфигурационным и системным файлам
    location ~ (\.git|\.config|\.log|\.json|\.lock|\.bak|~)$ {
        deny all;
        return 404;
    }
    
    # SSL настройки
    listen 443 ssl http2;
    ssl_certificate /etc/letsencrypt/live/xn--h1aqlos.xn--p1ai/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/xn--h1aqlos.xn--p1ai/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}

# Редирект с HTTP на HTTPS
server {
    listen 80;
    server_name xn--h1aqlos.xn--p1ai;
    return 301 https://$server_name$request_uri;
}
